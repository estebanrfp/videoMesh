<base href=".">
<h1>GUNjs P2P Video Mesh Test Tool</h1>
<div id="sign">
	Login, Register or Delete User<br>
	<input id="alias" placeholder="username">
	<input id="pass" type="password" placeholder="passphrase">
	<input id="login" type="button" value="Login">
	<input id="up" type="button" value="Register">
	<input id="delUsr" type="button" value="Delete">
</div>
Local User: <span id="localUser"></span><br>
<video id="videoStream" height="120" width="160" autoplay ></video>
<br>
<div id="signed" >
	All User Names:
	<div id="users"></div>
	<br>

	<select name="Rooms" id="roomName">
		<option value="chatting" selected="selected">Chatting</option>
		<option value="blah">Blah</option>
		<option value="serious">Serious</option>
	</select>
	<input id="enterRoom" type="button" value="Enter Room">
	<input id="clearRoom" type="button" value="Clear Room">
	<input id="leaveRoom" type="button" value="Leave Room">
	<br>
	Current Room: <span id="currentRoom"></span>
	<br>
	Remote Video(s):
	<div id="videos"></div>
	<br>
</div>





<script src="https://code.jquery.com/jquery-1.12.4.js" integrity="sha256-Qw82+bXyGq6MydymqBxNPYTaUXXq7c8v3CwiYwLLNXU="  crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/nts.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/rindexed.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/webrtc.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/path.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/open.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/load.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/not.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/unset.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.7.2/simplepeer.min.js"></script>

<script>
const vgaConstraints = {
	width: { ideal: 320 },
	height: { ideal: 160 }
};
const gun =  Gun({
      localStorage: false,
      peers: [location.origin + '/gun']
    });
const user = gun.user();
const clearUsers = () => {
	const users = document.getElementById('users');
	while (users.firstChild) {
		users.removeChild(users.firstChild);
	}
}
const videoStream = document.getElementById('videoStream');

let peers = {};
let nodeId = null;
let stream = null;
let roomName = null;

const initPeer = (peerId, remotePeer, initiator) => {
	if(peers[peerId]){
		return;
	}
	gun.get('signal').get(peerId).on((str) => {
		let data = JSON.parse(str);
		if (data) {
			if(data.for && peers[data.for]){
				if(!peers[data.for].destroyed){
					//console.log('got signal for '+data.for);
					//console.log(data.data);
					peers[data.for].signal(data.data);
				}
			}
		}
	});
	peers[peerId] = new SimplePeer({
		initiator,
		trickle: false,
		stream
	});
	peers[peerId].on('signal', data => {
		//console.log('sending signal to '+remotePeer);
		gun.get('signal').get(remotePeer).put(JSON.stringify({for:remotePeer, from: peerId, data: data}));
	});
	peers[peerId].on('connect', () => {
		// wait for 'connect' event before using the data channel
		//peer.send('connected '+$('#alias').val()+' sends greetings');
		console.log(peerId + ' connected');
		//peers[peerId].addStream(stream);
	});
	peers[peerId].on('data', data => {
		// got a data channel message
		console.log(peerId + 'got a message ' + data);
	});
	peers[peerId].on('stream', (stream) => {
		// got remote video stream, now let's show it in a video tag
		const videos = document.getElementById('videos');
		const video = window.document.createElement('video');
		video.width = 160;
		video.height = 120;
		video.autoplay = true;
		video.muted = false;
		video.id = peerId;
		videos.appendChild(video);
		if ('srcObject' in video) {
			video.srcObject = stream;
		} else {
			video.src = window.URL.createObjectURL(stream); // for older browsers
		}
		video.play();
	});
	peers[peerId].on('close', () => {
		const videos = document.getElementById('videos');
		for (const video of videos.children) {
			if(video.id === peerId){
				videos.removeChild(video);
			}
		}
	});
}

const enterRoom = async (room) => {

	const videos = document.getElementById('videos');
	while (videos.firstChild) {
		videos.removeChild(videos.firstChild);
	}

	await gun.get('com').get(room).on((str) => {
		let mesh = JSON.parse(str);
		if (mesh && stream && nodeId) {
			let meshNodeIds = Object.keys(mesh);
			meshNodeIds.sort((a, b) => a.localeCompare(b)); // timestamps
			if (meshNodeIds.length > 1) {
				for (let mnId of meshNodeIds) {
					for (let n in mesh[mnId].remotePeers) {
						if (!mesh[mnId].remotePeers[n].initRepl && n === nodeId) {
							initPeer(mesh[mnId].remotePeers[n].id, mesh[mnId].remotePeers[n].localPeer, false);
							mesh[mnId].remotePeers[n].initRepl = true;
							console.log(mesh);
							gun.get('com').get(room).put(JSON.stringify(mesh));
						}
					}
				}
			}
		}
	});

	gun.get('com').get(room).once(async(str) => {
		// init mesh
		let mesh = null;
		try{
			mesh = JSON.parse(str);
		} catch(ex){console.log('new mesh')};
		if(!mesh){
			mesh = {};
		}
		nodeId = Date.now()+'';
		mesh[nodeId] = {
			remotePeers: {}
		}

		// init peer mesh
		let meshNodeIds = Object.keys(mesh);
		meshNodeIds.sort((a, b) => a.localeCompare(b)); // timestamps
		if (meshNodeIds.length > 1) {
			let isFirst = true;
			for (let mnId of meshNodeIds) {
				if(isFirst){
					isFirst = false;
				}else{
					if (!mesh[mnId].init && mnId === nodeId) {
						let ctr = 0;
						for(let m of meshNodeIds){
							ctr++;
							if( mnId !== m ){
								const l = Date.now()+'_'+ctr+'l';
								const r = Date.now()+'_'+ctr+'r';
								mesh[mnId].remotePeers[m] = {
									id: r,
									localPeer: l
								};
								initPeer(l, r, true);
							}
						}
						mesh[mnId].init = true;
					}
				}
			}
		}
		console.log(mesh);
		gun.get('com').get(room).put(JSON.stringify(mesh));
	});
}

const loggedIn = async () => {
	await gun.get('usrs').open(async (pubUsers)=>{
		clearUsers();
		const users = document.getElementById('users');
		for(const key in pubUsers) {
			if (pubUsers[key] && pubUsers[key].alias) {
				const usr = window.document.createElement('div');
				usr.innerHTML = pubUsers[key].alias;
				users.appendChild(usr);
			}
		}
	}).then();

	if (navigator.mediaDevices.getUserMedia) {
		console.log('getUserMedia supported.');
		const constraints = {  video: vgaConstraints, audio: true };
		const gotMedia = async (vs) => {
			videoStream.srcObject = vs;
			videoStream.muted = true;
			stream = vs;
		}
		const onError = (err) => {
			console.log('The following error occurred: ' + err);
		}
		await navigator.mediaDevices.getUserMedia(constraints).then(gotMedia, onError).then(()=> console.log('got usr media'));
	} else {
		console.log('getUserMedia not supported on your browser!');
	}
};

$('#signed').hide();

$('#clearRoom').on('click', async (e)=> {
	const currentRoom = document.getElementById("currentRoom");
	currentRoom.innerHTML = '';
	const videos = document.getElementById('videos');
	while (videos.firstChild) {
		videos.removeChild(videos.firstChild);
	}
	await gun.get('com').get(roomName).once(async(str) => {
		const mesh = JSON.parse(str);
		for (const m in mesh) {
			for(const r in mesh[m].remotePeers){
				peers[mesh[m].remotePeers[r].id] ? peers[mesh[m].remotePeers[r].id].destroy() : null;
				peers[mesh[m].remotePeers[r].localPeer] ? peers[mesh[m].remotePeers[r].localPeer].destroy() : null;
				delete peers[mesh[m].remotePeers[r].id];
				delete peers[mesh[m].remotePeers[r].localPeer];
			}
		}
	}).then();
	gun.get('com').get(roomName).put(null);
});

$('#enterRoom').on('click', async (e)=> {
	const ddRoom = document.getElementById("roomName");
	roomName = ddRoom.options[ddRoom.selectedIndex].value;
	const currentRoom = document.getElementById("currentRoom");
	currentRoom.innerHTML = roomName;
    await enterRoom(roomName);
});

$('#leaveRoom').on('click', async (e)=> {
	const currentRoom = document.getElementById("currentRoom");
	currentRoom.innerHTML = '';

	await gun.get('com').get(roomName).once(async(str) => {
		const mesh = JSON.parse(str);
		// destroy self initiated peers
		for(const r in mesh[nodeId].remotePeers){
			peers[mesh[nodeId].remotePeers[r].id] ? peers[mesh[nodeId].remotePeers[r].id].destroy() : null;
			peers[mesh[nodeId].remotePeers[r].localPeer] ? peers[mesh[nodeId].remotePeers[r].localPeer].destroy() : null;
			delete peers[mesh[nodeId].remotePeers[r].id];
			delete peers[mesh[nodeId].remotePeers[r].localPeer];
		}
		//mesh[nodeId] = null;

		// destroy other initiated peers
		for (const m in mesh) {
			for(const r in mesh[m].remotePeers){
				if(r===nodeId){
					peers[mesh[m].remotePeers[r].id] ? peers[mesh[m].remotePeers[r].id].destroy() : null;
					peers[mesh[m].remotePeers[r].localPeer] ? peers[mesh[m].remotePeers[r].localPeer].destroy() : null;
					delete peers[mesh[m].remotePeers[r].id];
					delete peers[mesh[m].remotePeers[r].localPeer];
				}
			}
		}
	}).then();
});

$('#up').on('click', function(e){
  user.create($('#alias').val(), $('#pass').val(), async (ack) => {
	if (!ack.err) {
	  await gun.get('usrs').set({ alias:$('#alias').val(), pub: ack.pub }).then();
	  user.auth($('#alias').val(), $('#pass').val(), (res)=>{
		if(!res.err){
		  user.get('pictures').set(null);
		  user.get('stream').set(null);
		}
	  });
	}
  });
});

$('#delUsr').on('click', (e)=>{
	gun.get('usrs').load( (usrs) =>{
		for(let u in usrs){
			if(usrs[u] && $('#alias').val()=== usrs[u].alias){
				gun.get('usrs').get(u).put(null);
				
			}
		}
	});

	user.delete($('#alias').val(), $('#pass').val(),  (ack) => {
		if(!ack.err){
			$('#sign').css("display", "block");
		}
	});
});

$('#logOut').on('click', ()=>{
	user.leave();
	user = gun.user();
	$('#said').hide();
	$('#sign').css("display", "block");
	const usr = document.getElementById('currentUser');
	usr.innerHTML = "";
});


async function login(e){
	await user.auth($('#alias').val(), $('#pass').val()).then();
  return false; // e.preventDefault();
};
$('#login').on('click', ()=>{
	user.auth($('#alias').val(), $('#pass').val());
});


gun.on('auth', function(){
	$('#sign').hide();
	$('#said').css("display", "block");
	$('#signed').css("display", "block");
	const usr = document.getElementById('localUser');
	usr.innerHTML = $('#alias').val();
	loggedIn();
});

</script>
